- name:  create ovs network
  hosts: myserver
  become: true

  tasks:
    - name: remove ovs bridges
      ansible.builtin.shell: |
        ovs-vsctl --if-exists del-br {{ item.name }}
        
#        num=`virsh net-list | grep {{ item.ovsnet}} | wc -l`
#        if [ "$num" -ne 0 ]; then
#          virsh net-destroy {{ item.ovsnet }}
#        fi
      loop: "{{ bridges }}"
    
#    - name: remove gre0, gretap0, erspan0 from kernel
#      ansible.builtin.modprobe:
#        name: "{{ item }}"
#        state: absent
#      loop:
#        - ip_gre
#        - gre
    
    - name: remove gre0, gretap0, erspan0 from kernel
      ansible.builtin.shell: |
        rmmod "{{ item }}"
      loop:
      - ip_gre
      - gre
      ignore_errors: true

    - name: remove ovs bridge connections
      ansible.builtin.shell: |
        name=`nmcli con | awk '{ print $1 }' | grep -e '^{{ item.name }}$'`
        if [ ! -z "$name" ]; then
          nmcli con del {{ item.name }}
        fi
      loop: "{{ bridges }}"
    
    - name: remove ovs bridge devices
      ansible.builtin.shell: |
        name=`nmcli dev | awk '{ print $1 }' | grep -e '^{{ item.name }}$'`
        if [ ! -z "$name" ]; then
          nmcli dev del {{ item.name }}
        fi
      loop: "{{ bridges }}"

