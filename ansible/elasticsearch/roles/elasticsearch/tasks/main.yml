---
- name: add elasticsearch keyrings
  ansible.builtin.shell: |
    wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch \
    | gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg \
        --batch --yes

- name: install apt-transport-https
  ansible.builtin.apt :
    name: apt-transport-https
    state: present

- name: add source list
  ansible.builtin.shell: |
    echo "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/{{ elastic_ver }}/apt stable main" \
      | tee /etc/apt/sources.list.d/elastic-{{ elastic_ver }}.list

- name: install elasticsearch
  ansible.builtin.apt :
    name: elasticsearch
    state: present
    update_cache: true

- name: enable api_key
  ansible.builtin.lineinfile:
    path: /etc/elasticsearch/elasticsearch.yml
    line: 'xpack.security.authc.api_key.enabled: true'
    insertafter: '^xpack.security.enabled: true'

- name: upload heap1gb.options
  ansible.builtin.template:
    src:  heap1gb.options
    dest: /etc/elasticsearch/jvm.options.d/

- name: start elasticsearch
  ansible.builtin.systemd_service:
    name: elasticsearch
    state: restarted
    enabled: true

