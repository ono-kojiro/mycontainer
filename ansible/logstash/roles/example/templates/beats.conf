# Sample Logstash configuration for creating a simple
# Beats -> Logstash -> Elasticsearch pipeline.

input {
  beats {
    port => 5044
    ssl_enabled => true
    ssl_certificate_authorities => [ "/etc/ssl/certs/ca-certificates.crt" ]
    ssl_certificate => "/etc/logstash/certs/logstash.crt"
    ssl_key         => "/etc/logstash/certs/logstash.key"
    ssl_client_authentication => "optional"
  }
}

filter {
  if ("filebeat_id" in [@metadata]) {
    mutate {
      add_field => { "[@metadata][target_index]" => "%{[@metadata][filebeat_id]}" }
    }  
  }
  else {
    mutate {
      add_field => { "[@metadata][target_index]" => "default" }
    }  
  }

  if [@metadata][filebeat_id] == "mycsv" {
    if [message] =~ /^id,/ {
      drop { }
    }
    else {
      csv {
        separator => ","
        columns => [ "id", "key", "value" ]
      }
      mutate {
        strip => [ "id", "key", "value" ]
      }
    }
  }
}

output {
  elasticsearch {
    hosts => [ "https://192.168.0.98:9200" ]
    #index => "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
    index => "%{[@metadata][beat]}-%{[@metadata][target_index]}-%{+YYYY.MM.dd}"
    api_key => "{{ api_key_id }}:{{ api_key }}"
    ssl_enabled => true
    ssl_verification_mode => "none"
    action => "create"
  }
}

