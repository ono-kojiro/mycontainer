---
- name: load modules
  ansible.builtin.shell: |
    num=`ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b "cn=config" \
      "objectClass=olcModuleList" olcModuleLoad \
      | grep -e '^olcModuleLoad:.*{{ item }}' | wc -l`

    if [ "$num" = "0" ]; then
      cat - << EOF | ldapmodify -Q -Y EXTERNAL -H ldapi:///
    dn: cn=module{0},cn=config
    changetype: modify
    add: olcModuleLoad
    olcModuleLoad: {{ item }}
    EOF
    
    fi
  loop:
  - refint

- name: check if refint overlay exists
  ansible.builtin.shell: |
    ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// \
      -b "cn=config" \
      "(&(objectClass=olcOverlayConfig)(olcOverlay=refint))" \
      dn | wc -l
  register: res

- name: enable refint overlay
  ansible.builtin.shell: |
    cat - << EOF | ldapmodify -Q -Y EXTERNAL -H ldapi:///
    dn: olcOverlay=refint,{{ olc_database }}
    changetype: add
    objectClass: olcConfig
    objectClass: olcRefintConfig
    objectClass: olcOverlayConfig
    objectClass: top
    olcOverlay: refint
    olcRefintAttribute: memberof
    EOF
  when: res.stdout == "0"
  ignore_errors: true

- name: restart slapd for refint
  ansible.builtin.systemd:
    name: slapd
    state: restarted
    enabled: true
    daemon_reload: true

